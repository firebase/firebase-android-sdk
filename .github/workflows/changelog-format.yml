name: Changelog Format

on:
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Get changed changelog files
      id: changed-files
      uses: tj-actions/changed-files@v36.0.10
      with:
        since_last_remote_commit: true
        files: |
          **/CHANGELOG.md

    - name: Try to make release notes
      id: make-release-notes
      if: ${{steps.changed-files.outputs.any_changed == 'true'}}
      run: ./gradlew makeReleaseNotes
        
    - name: Generate release note diffs
      if: ${{ steps.make-release-notes.outcome == 'success' }}
      run: |
        for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
          SDKName=$file | sed ".*(?=/)"s
          ReleaseNotes="${SDKName}/build/tmp/makeReleaseNotes/release_notes.md"
          Text=cat $ReleaseNotes
          read -r -d '' formatted <<-EOF
            <details>
            <summary>${SDKName}</summary>
  
            ```markdown
            ${Text}
            ```
            </details>
EOF
          echo $formatted >> $GITHUB_OUTPUT
        done

    - name: Add PR Comment
      uses: mshick/add-pr-comment@a65df5f64fc741e91c59b8359a4bc56e57aaf5b1
      with:
        message-success: |
          The following release notes were modified. Please ensure they look correct.
          <details>
          <summary>Release Notes</summary>
          
          </details>
        message-failure: |
          A `CHANGELOG.md` file seems to not match the expected format.
          Please ensure your changelog files are following the format as
          defined in [our documentation](#).